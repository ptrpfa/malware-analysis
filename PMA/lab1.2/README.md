# Lab 1-2 (Static Analysis)

Analyze the file `Lab01-02.exe`.

## Questions

1. Upload the `Lab01-02.exe` file to [VirusTotal](http://www.VirusTotal.com/). Does it match any existing antivirus definitions?

    <ins>Packed Executable</ins>
    - First derive the hash of `Lab01-02.exe`:	
        - MD5: `8363436878404da0ae3e46991e355b83`	
        - SHA1: `5a016facbcb77e2009a01ea5c67b39af209c3fcb`	
        - CRC32: `573cec0f`	
        - SHA256: `c876a332d7dd8da331cb8eee7ab7bf32752834d4b2b54eaa362674a2a48f64a6`	
        - SHA512: `0e2ceca7588462380d4c523dd59ffae8419f9ef0b5f9df4c319b0d6f076d3b5b31ec97ae979614b1557c846b2df4db5e07abd8885a95079cd68b24a02cda4979`	
        - SHA384: `97127e434621e60d4fda17c100feb567c12f695dde28dd0a31de2ebba6546192eced3fbbc0a9923ece87477a2589eb0a`
    - VirusTotal
        - The file was flagged by 59/74 security vendors
    - Hybrid-Analysis
        - Flagged as malicious

    <ins>Unpacked Executable</ins>
    - Derived hash:	
        - MD5: `ae4ca70697df5506bc610172cfc288e7`	
        - SHA1: `31e8a82e497058ff14049cf283b337ec51504819`	
        - CRC32: `c510c9f8`	
        - SHA256: `8bcbe24949951d8aae6018b87b5ca799efe47aeb623e6e5d3665814c6d59aeae`	
        - SHA512: `8c5f7b991635c68b18ba59030312a0e1fd2b46e53678211527ef95e7b3f22368b0eeba2787cf7bcfc9b85409b199e0730314300910336e38e2baf06c8f8b8107`	
        - SHA384: `6bdfe68a540a40e3ebbd72976852638952dd748e924b300a47b09f0220be13666a97987e882f11684de25fcf3aaa34b4`
    - VirusTotal
        - The file was flagged by 59/74 security vendors
    - Hybrid-Analysis
        - Flagged as malicious

2. Are there any indications that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible.
    
    <ins>Detection</ins>
    - Section headers consist of `UPx0`, `UPX1`, and `UPX2`, without the normal conventional section headers like `.text`. This suggests that the file has been packed, specifically using the UPX packer.
    - There is a considerable mismatch between the virtual size and raw data size of sections, with the virtual size being much larger. This suggests that the file is packed.
    - `PE Studio` labels the file as having the signature/tooling of `Visual Studio 6.0 | UPX v0.8X`, where UPX is a packer program.
    - File contains the following embedded strings that are highly suggestive of it being packed:
        ```
        UPX0
        UPX1
        UPX2
        3.04
        UPX!
        ```
    - Using the `PEiD` tool, the file is detected to have been packed using the `UPX` packer.
    - **Revision**: Relatively small number of imports
    - **Revision**: `UPX0` section is the largest and the only one marked executable, suggesting that it contains the original unpacked code!

    <ins>Unpacking</ins>
    - Using the `UPX` tool, we unpacked the file (no password required) successfully.   
        ```
        upx -d <file.exe> -o <output_file.exe>
        ```

3. Do any imports hint at this program’s functionality? If so, which imports are they and what do they tell you?

    <ins>Packed Executable</ins>
    - Unpacking
        - The presence of `LoadLibraryA` and `GetProcAddress`, which are functions commonly used to unpack packed programs.
        - The functions `VirtualProtect`, `VirtualAlloc` and `VirtualFree` are incriminating functions that are suggestive of the file's unpacking functions.
        - `ExitProcess` suggests the termination of some process
    - Stealth Service
        - The presence of `CreateServiceA` suggests the creation of a service that will run in the background of infected machines.
    - Termination
        - The presence of `exit` from the `msvcrt.dll` suggests that the malware will exit a process, perhaps to evade detection
    - Network Connection/Communications
        - The presence of `InternetOpenA` from the `WININET.dll` suggests that the malware will perform some network communications, perhaps to communicate with its main C2 server.

    <ins>Unpacked Executable</ins>
    - Thread Creation
        - The presence of `CreateThread`, `CreateMutexA` and `OpenMutexA` suggests the creation of threads by the unpacked executable, as well control of its access through synchronisation mechanisms (mutexes).
    - Process Termination
        - The presence of `ExitProcess` suggests the termination of processes by the executable
    - Evasion
        - The presence of `SetWaitableTimer` suggests potential evasion mechanisms by the malware to lay dormant in infected machines, before delivering its malicious payload and performing its activities.
    - Service Creation & Execution
        - The presence of `CreateServiceA`, `StartServiceCtrlDispatcherA`, and `OpenSCManagerA` suggests the creation and starting of a service that will run in the background of infected machines.
    - Termination
        - The presence of `exit` from the `msvcrt.dll` suggests that the malware will exit a process, perhaps to evade detection
    - Network Connection/Communications
        - The presence of `InternetOpenA` and `InternetOpenUrlA` from the `WININET.dll` suggests that the malware will perform some network communications, perhaps to communicate with its main C2 server. The latter function also suggests that the malware may download some payload to the infected machine.

4. What host- or network-based indicators could be used to identify this malware on infected machines?

    <ins>Packed Executable</ins>
    - Presence of the following incriminating embedded strings:
        ```
        Rich
        UPX0
        UPX1
        UPX2
        3.04
        UPX!
        MalService
        sHGL345
        http://w
        warean
        ysisbook.co
        om#Int6net Explo!r 8FEI
        exit
        ```
    - Connection to `http://wwareanysisbook.com` domain
    - Presence of a service, possibly called `MalService`

    <ins>Unpacked Executable</ins>
    - Presence of the following incriminating embedded strings:
        ```
        Rich
        MalService
        Malservice
        HGL345
        http://www.malwareanalysisbook.com
        Internet Explorer 8.0
        ```
    - Connection to the `http://www.malwareanalysisbook.com` domain
    - Presence of a service, possibly called `MalService`

## Solutions
<ins>Short Answers</ins>
1. As of this writing, the file matches 3 of 41 antivirus signatures.

2. There are several indications that the program is packed with UPX. You can unpack it by downloading UPX and running` upx –d`.

3. After unpacking the file, you’ll see that the most interesting imports are `CreateService`, `InternetOpen`, and `InternetOpenURL`.

4. You should check infected machines for a service called `Malservice` and for network traffic to `http://www.malwareanalysisbook.com/`. 

<ins>Detailed Analysis</ins>

1. When analyzing Lab 1-2, we upload the file to VirusTotal.com and see that it matches at least three virus signatures. One antivirus engine identifies it as a malicious downloader that downloads additional malware; the other two identify it as packed malware. This demonstrates the usefulness of VirusTotal.com. Had we used only one antivirus program to scan this file, we would probably not get any information. 

2. Upon opening the file with `PEview`, several indicators tell us that this file is packed. The most obvious indicators are sections named `UPX0`, `UPX1`, and `UPX2` section names for UPX-packed malware. We could use `PEiD` to confirm the file’s packed nature, but it is not foolproof. Even if PEiD fails to identify the file as UPX-packed, notice the **relatively small number of imports** and that the first section, `UPX0`, has a <ins>virtual size of 0x4000 but a raw data size of 0</ins>. 

    **`UPX0` is the largest section, and it’s marked executable, so it’s probably where the original unpacked code belongs.**

3. Having identified the program as packed, we can unpack it by downloading `UPX` from `http://upx.sourceforge.net/` and running the following command: `upx -o newFilename -d originalFilename`. The `-d` option says decompress the file, and the `-o` option specifies the output filename. 
    
    After unpacking, we look at the imports sections and the strings. The imports from `kernel32.dll` and `msvcrt.dll` are imported by nearly every program, so they tell us little about this specific program. The imports from `wininet.dll` tell us that this code connects to the Internet (`InternetOpen` and `InternetOpenURL`), and the import from `advapi32.dll` (`CreateService`) tell us that the code creates a service. 
    
    When we look at the strings, we see `www.malwareanalysisbook.com`, which is probably the URL opened by `InternetOpenURL` as well as by `Malservice`, which could be the name of the service that is created. We can’t be sure what this program is doing, but we’ve found some indicators to help search for this malware across a network.

## References
[Sample Solutions](https://github.com/SafeEval/practical-malware-analysis/blob/master/exercises/lab-01-2.md)