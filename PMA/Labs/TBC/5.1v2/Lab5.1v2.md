Lab 5-1

Analyze the malware found in the file `Lab05-01.dll` using only IDA Pro. The goal of this lab is to give you hands-on experience with IDA Pro. If youâ€™ve already worked with IDA Pro, you may choose to ignore these questions and focus on reverse-engineering the malware.

### Malware Flow
- Entrypoint `Dllmain` at `1000D02E`
    - Checks if the string stored at  offset `10019044` in memory  is equal to `http:////` or `ftp:////`, and executes newly created threads accordingly.
    - The following threads will be created accordingly:
        - `http:////`: `sub_10001074` (`httpPayload`)
        - `ftp:////`: `sub_10001365` (`ftpPayload`)

- `sub_10001074` (`httpPayload`)
    - First calls `sub_10001000` (`checkProcessCaller`) to ensure that the DLL is not exectuted by the `rundll32.exe` or `rundll64.exe` processes to evade inspection and detection by malware analysts
    - Makes a call to `commsHTTP` which performs the following tasks:
        - Sends a HTTP request:
            ```
            GET HTTP/1.1 \r\n
            Host: XX
            Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, application/vnd.ms-excel, application/vnd.ms-powerpoint, application/msword, */*
            User-Agent: Mozilla/4.0 (compatible; MSIE 6.00; Windows NT 5.1)
            Connection: Keep-Alive
            Pragma: no-cache
            Cache-Control: no-cache, must-revalidate
            Expires: 0
            ```
        - Receives response, and performs actions including writing to a file, file deletion
    - Clears the DNS cache by executing `ipconfig /flushdns`
    - Decodes the character received from `commsHTTP`
    - Gets hostname and IP address of target domain to connect to
    - Sleeps for an specified amount of time (seconds)

- `sub_10001365` (`ftpPayload`)
    - First calls `sub_10001000` (`checkProcessCaller`) to ensure that the DLL is not exectuted by the `rundll32.exe` or `rundll64.exe` processes to evade inspection and detection by malware analysts
    - Makes a call to `sub_1000208F` (`ftpComms`) which opens a socket and makes a connectoin


### Points of Interest
- Sections
    - `xdoors_d` (share and write permissions)
    - `.rsrc`
        - Contains version info
        ![rsrc](./rsrc.png)

- Imports
    - Network Connection
        - `WS2_32.dll` (import by ordinal)
            - `select`, `inet_addr`, `gethostbyvalue`, `inet_ntoa`, `recv`, `send`, `connect`, `ntohs`, `htons`, `setsockopt`, `WSACleanup`, `WSAStartup`, `closesocket`, `socket`, `WSAGetLastError`, `GetAdaptersInfo`

    - Process Manipulation
        - `PSAPI.dll`
            - `EnumProcessModules`, `GetModuleFileNameExA`
        - `KERNEL32.dll`
            - Process
                - `GetCurrentProcess`, `Process32Next`, `Process32First`, `TerminateProcess`, `OpenProcess`, `GetCurrentProcessId`, `WinExec`, `CreateProcessA`, `CreatePipe`, `WriteProcessMemory`, `VirtualAllocEx`
            - Thread
                - `SuspendThread`, `Thread32First`, `ResumeThread`, `TerminateThread`, `CreateThread`, `CreateRemoteThread`, `GetCurrentThreadId`
        - `ADVAPI32.dll`
            - `CreateProcessAsUserA`

    - File Manipulation
        - `KERNEL32.dll`
            - `ReadFile`, `GetSystemDirectoryA`, `GetWindowsDirectoryA`, `CreateFileA`, `DeleteFileA`, `RemoveDirectoryA`, `MoveFileA`, `FindFirstFileA`, `FindNextFileA`

    - Registry Manipulation
        - `ADVAPI32.dll`
            - `RegCloseKey`, `RegQueryValueExA`, `RegOpenKeyExA`, `RegSetValueExA`, `RegDeleteValueA`, `RegEnumKeyA`, `RegEnumValueA``RegOpenKeyA`, `RegCreateKeyA`, `RegCreateKeyA`

    - Service Manipulation
        - `ADVAPI32.dll`
            - `CloseServiceHandle`, `QueryServiceConfigA`, `RegisterServiceCtrlHandlerA`, `SetServiceStatus`, `CreateServiceA`, `ChangeServiceConfig2A`, `QueryServiceStatusEx`, `ChangeServiceConfigA`, `StartServiceA`,  `QueryServiceStatus`, `ControlService`, `DeleteService`, `OpenSCManagerA`, `OpenSCManagerA`, `QueryServiceConfig2A`, `OpenServiceA`

    - Privilege Escalation
        - `ADVAPI32.dll`
            - `LookupPrivilegeValueA`, `AdjustTokenPrivileges`, `DuplicateTokenEx`, `SetTokenInformation`, `OpenProcessToken`

    - Mutex Manipulation
        - `KERNEL32.dll`
            - `CreateMutexA`, `InitialiseCriticalSection`, `EnterCriticalSection`, `LeaveCriticalSection`

    - Component Object Model Manipulation
        - `ole32.dll`
            -  `CoTaskMemFree`, `CoInitialize`, `CoInitializeEx`, `CoCreateInstance`, `CoUninitialize`

    - Miscellaneous
        - `KERNEL32.dll`
            - `Sleep`, `WaitForSingleObject`
        - `USER32.dll`
            - `BlockInput`, `mouse_event`, `keybd_event`
        - `WINMM.dll` (sound library)
            `waveInReset`, `waveInOpen`, `waveInClose`, `waveInUnprepareHeader`, `waveInPrepareHeader`, `waveInAddBuffer`, `waveInStart`
        - `MSVFW32.dll` (video library)
            - `ICCompress`, `ICClose`, `ICSendMessage`, `ICOpen`, `ICImageCompress`
- Exports
    - `InstallRT`
    - `InstallSA`
    - `InstallSB`
    - `PSLIST`
    - `ServiceMain`
    - `StartEXS`
    - `UninstallRT`
    - `UinstallSA`
    - `UinstallSB`

- Embedded Strings
    - ASCII Strings
        ```
        [This is PWD]   
        [This is RGP]         
        [This is RNA]pics
        [This is RUR]
        [This is RDO]pics.praticalmalwareanalysis.com
        [This is RIP] 
        [This is RPO]80
        [This is DVM]      
        [This is SS2]      
        [This is SSD]      
        [This is LOG]0
        [This is NTI]30
        [This is CTI]30
        .?AV_com_error@@
        warning LSP High 
        warning LSP Low 
        .?AVtype_info@@
        xsys.dll
        plug_sys
        update
        logoff
        shutdown
        reboot
        fgets
        message
        startxservices
        startxprocess
        startxsound
        startxvideo
        startxreg
        startxfile
        startxscreen
        startxcmd
        uninstall
        uninstall+reboot
        suspendx
        urlh
        urln
        exeh
        exen
        delgroupinfo
        setgroupinfo
        delhostinfo
        sethostinfo
        socket() GetLastError reports %d
        Plug_KeyLog_Restart
        xkey.dll
        WSAStartup() error: %d
        RETR %s
        PASV
        SIZE %s
        TYPE I
        CWD %s
        PASS %s
        USER %s
        Socket error....
        IEuser@
        anonymous
        FTP://
        ftp://
        Content-Length:
        HTTP/1.1 5
        HTTP/1.1 3
        HTTP/1.1 4
        Expires: 0
        Cache-Control: no-cache, must-revalidate
        Pragma: no-cache
        Connection: Keep-Alive
        User-Agent: Mozilla/4.0 (compatible; MSIE 6.00; Windows NT 5.1)
        Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, application/vnd.ms-excel, application/vnd.ms-powerpoint, application/msword, */*
        Host: 
        HTTP/1.1
        GET 
        HTTP://
        http://
        GetLastInputInfo
        user32.dll
        [%s %s]
        xinstall.log
        0.0.0.0
        Microsoft TV/Video Connection
        VMware Virtual Ethernet Adapter
        Fail To Send()
        %s %s
        ftp:////
        http:////
        SeShutdownPrivilege
        HardwareInformation.MemorySize
        System
        \Device\Video0
        HARDWARE\DEVICEMAP\VIDEO
        F333
        kernel32.dll
        GetDiskFreeSpaceExA
        ~MHz
        HARDWARE\DESCRIPTION\System\CentralProcessor\0
        default
        GroupInfo
        HostInfo
        SOFTWARE\Microsoft\Windows\CurrentVersion
        Fail To Create Snap Shot
        (1) Enter Current Directory Error,Update Failed
        (2) Get DLL FileName Error,Update Failed
        (3) Move '%s' To '%s' Failed,Perhaps Other Process Updateing|Updated Same Module
        (4) Resume '%s' To '%s' Failed,Update Failed
        (4) Resume '%s' To '%s' Successfully,Update Failed
        (4) Get New FileName Error,Update Failed
        (6) Update Successfully,Will Take Effect Until Next Reboot
        (5) New FileName As Old FileName
        (6) Resume '%s' To '%s' Successfully,Update Failed!!!
        (5) Move '%s' To '%s' Failed,Update Failed
        (5) Copy '%s' To '%s' Successfully
        (4) Get New FileName '%s'
        (3) Move '%s' To '%s' Successfully
        .ubak
        (2) Get DLL FileName '%s'
        (1) Enter Current Directory '%s'
        ******************************
        [BackDoor Server Update Setup]
        ******************************
        -warn
        -erro
        -stop
        -shutdown
        -reboot
        Default
        WinSta0
        winsta0\default
        EXPLORER.EXE
        %s\IEXPLORE.EXE
        Path
        SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\IEXPLORE.EXE
        [Machine IdleTime:] %d days + %.2d:%.2d:%.2d
        [Machine UpTime:] %-.2d Days %-.2d Hours %-.2d Minutes %-.2d Seconds
        [Language:] id:0x%x
        [Install Log:] %d
        [Detect VM  :] %d
        [SSDT Ring3 :] %d
        [SSDT Ring0 :] %d
        [Host connect Type  :] %d
        [Host Reconnect Time:] %d
        [CURL Reconnect Time:] %d
        [DOMAIN_NAME:] 
        [CURL       :] 
        [HOST_NAME  :] 
        [PASS       :] 
        [PORT       :] 
        [HOST       :] 
        [Module:] 
        [Masthost:] %s:%s
        [Robot_WorkTimes:] %d
        WorkTimes
        [Robot_WorkTime :] %d
        WorkTime
        ServiceDll
        SYSTEM\CurrentControlSet\Services\%s\Parameters\
        SYSTEM\CurrentControlSet\Services\
        del %%0
        if exist "%s" goto selfkill
        del "%s"
        attrib -a -r -s -h "%s"
        :selfkill
        @echo off
        .\vmselfdel.bat
        kstarttype
        CreateToolhelp32Snapshot
        OpenProcess
        WaitForSingleObject
        CreateRemoteThread
        failed
        Load the sfc fuction failed
        unsupported version
        Windows XP
        sfc_os.dll
        Win2000
        sfc.dll
        error on get process info. 
        winlogon.exe
        xinstall.dll
        AdjustTokenPrivileges failed: %u
        LookupPrivilegeValue error:%d
        ntdll.dll
        NtQuerySystemInformation
        %-16d%-20s%d
        [%s]
        ProcessID       ProcessName         ThreadNumber
        Process32First() Fail:Error %d
        [%s]
        %-16d%-20s%d
        CreateToolhelp32Snapshot Fail:Error%d
        OpenProcessToken Error: %d
        kernel32
        OpenThread
        smss.exe
        csrss.exe
        lsass.exe
        services.exe
        svchost.exe
        Winlogon
        winsta0
        WmsgSendMessage
        DISPLAY
        .scr
        WinSta0\Winlogon
        WinSta0\Default
        logonui.exe
        rundll32.exe %s,StartEXS %s:%s
        explorer.exe
        %s%s
        %s\%s
        1234567890
        System Volume Information
        %s*.*
        HKEY_USERS
        HKEY_LOCAL_MACHINE
        HKEY_CURRENT_USER
        HKEY_CURRENT_CONFIG
        HKEY_CLASSES_ROOT
        AudioInThreadProc exit.
        MM_WIM_CLOSE 
        AudioInThreadProc start.
        CWaveIn::CloseDev: Device hasn't opened.
        CWaveIn::OpenDev: waveInOpen error.
        CWaveIn::OpenDev: Device has open.
        CWaveIn::StartThread: Strat wave in thread fail.
        CWaveIn::StartThread: Wave in thread has run.
        CWaveIn::StopThread: TerminateThread wave in thread.
        CWaveIn::StopThread: Wave in thread hasn't run.
        CWaveIn::PerPareBuffer: waveInAddBuffer error.
        CWaveIn::PerPareBuffer: waveInPrepareHeader error.
        CWaveIn::PerPareBuffer: waveInReset error.
        CWaveIn::PerPareBuffer: Buffer has been alloc.
        CWaveIn::FreeBuffer: waveInUnprepareHeader error.
        CWaveIn::FreeBuffer: m_pHdr is NULL.
        CWaveIn::FreeBuffer: Buffer hasn't been alloc.
        CWaveIn::OpenRecord: waveInStart error.
        CWaveIn::OpenRecord: You may be has begun recored.
        CWaveIn::CloseRecord: waveInReset error.
        CWaveIn::CloseRecord: Device hasn't opened.
        CWaveIn::CloseRecord: You may be hasn't begun recored.
        Completed
        SoftWare\MicroSoft\Internet Connection Wizard\
        MyStarService() -> OpenService() Error
        MyStarService() -> StartService() Error.
        StartService '%s' Successfully
        Open SCM error!
        MyStopService() -> OpenService() Error.
        MyStopService() -> ControlService() Error
        StopService '%s' Successfully
        Service '%s' Status already is Stopped.
        MyChangeService() -> OpenService '%s' Error.
        Change Service '%s' To Be Disabled
        Change Service '%s' To Be Manual-Start
        Change Service '%s' To Be Auto-Start
        Change Service '%s' Config Failed!
        Query registry service config failed!
        Alloc memory failed!
        Service '%s' Start Type Already Is Auto
        MyQueryServiceStarttype() -> OpenService '%s' Error.
        Query service starttype->%d
        _ox.dll
        .obak
        regedit.exe
        mmc.exe
        WatchServcicsMExeMutex
        GetModuleFileName() get dll path
        Kernel32
        LoadLibraryW
        Not Found Module '%s' In Any '%s' Process
        Found Module '%s' In PID %d
        Process '%s' Not Found ,Inject Failed
        Inject '%s' To Process '%s' Failed
        Inject '%s' To Process '%s' Successfully
        The PID Of Process '%s' is '%d'
        iexplore.exe
        Copy '%s' To '%s' Failed
        Copy '%s' To '%s' Successfully
        The PID Of Process '%s' Not Found
        Inject '%s' To Process '%s' Failed
        Inject '%s' To Process '%s' Successfully
        The PID Of Process '%s' is '%d'
        Copy '%s' To '%s' Failed
        Copy '%s' To '%s' Successfully
        Found Virtual Machine,Install Cancel.
        Description
        SYSTEM\ControlSet001\Services\
        win.ini
        Config service %s ok.
        %s error %d
        RegSetValueEx(ServiceDll)
        %SystemRoot%\system32\
        RegCreateKey(Parameters)
        Parameters
        RegOpenKeyEx(%s) KEY_SET_VALUE error %d.
        CreateService(%s) With Description '%s' SUCCESS. Config it
        CreateService(%s) error %d
        %SystemRoot%\System32\svchost.exe -k netsvcs
        OpenSCManager()
        Now Will Install Default Service '%s' With Description '%s' 
        - %s
        you specify service name not in Svchost\netsvcs, must be one of following:
        RegQueryValueEx(Svchost\netsvcs)
        netsvcs
        RegOpenKeyEx(%s) KEY_QUERY_VALUE error %d.
        SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost
        %s System Services
        Irmon
        Replace Old Service '%s' Failed,Install Cancle
        Old Module Not Runing,New ModuleName As Old,Will Take Effect Soon.
        Old Module Have Been Free,New ModuleName As Old,Will Take Effect Soon.
        %s.obak
        %s\dllcache\%s
        Inject '%s' to  PID '%d' Successfully!
        Old Module '%s' Still Runing,New Module '%s' Will Inject To PID '%d'
        Service '%s' Infect Successfully
        ServiceDll Set As '%s' Successfully
        ServiceMain Set As 'ServiceMain'
        RegSetValueEx(ServiceMain)
        ServiceMain
        RegQueryValueEx(%s) KEY_SET_VALUE error %d.
        Services '%s' Have Been Infected! Install Failed!
        ServiceMainbak
        \Parameters
        You Specify Service Name Not In Svchost\netsvcs, must be one of following:
        NtmsSvc
        Exception Catched 0x%X
        DeleteService(%s) SUCCESS.
        OpenService(%s) error %d
        OpenSCManager() error %d
        Service '%s' Do Not Need UnInstall.
        Service '%s' UnInstall Falied 2.
        Service '%s' UnInstall Falied 1.
        Service '%s' UnInstall Successfully,Please Reboot Machine To Take Effect
        ServiceMain Reset to '%s'
        Move '%s' To '%s' Successfully
        .\dllcache\%s
        %s.pbak
        ServiceDll Reset to '%s'
        .dll
        Kernel32.dll
        FreeLibrary
        Process '%s' Not Found,Uninject Failed
        Uninject '%s' From Process '%s' Failed
        Uninject '%s' From Process '%s' Failed, Module '%s' Not Found
        Uninject '%s' From Process '%s' Successfully
        '%s' Repair Failed,Bak File Lose!
        '%s' Repair Successfully,Need Reboot Machine!
        Move '%s' To '%s' Failed
        _bd.dll
        conime.exe
        MayBe Inject Mode,You Only Need Close Master Process '%s' To Uninatll This Mode
        No Found Old Bak Pe File->'%s' 
        Now Run UninstallPE %s
        Found Old Bak Pe File->'%s' 
        Get MasterProecss Path->'%s'
        Now Run UninstallSB %s
        Now Run UninstallSA %s
        Get ServiceName->'%s'
        Get ProcessName->'%s'
        Get ModuleName->'%s'
        Get ModulePath->'%s'
        Get Install Way->InstallRT
        Get Install Way->InstallPE
        Get Install Way->InstallSB Or InstallRSB
        Get Install Way->InstallSA
        Get ServiceName->'%s'
        Get ProcessName->'%s'
        Get ModuleName->'%s'
        Get ModulePath->'%s'
        CreateProcess() GetLastError reports %d
        inject
        minstall
        mmodule
        mhost
        mbase
        robotwork
        language
        uptime
        idle
        0x%02x
        enmagic
        exit
        quit
        \command.exe /c 
        \cmd.exe /c 
        Hi,Master [%d/%d/%d %d:%d:%d]
        WelCome Back...Are You Enjoying Today?
        Machine UpTime  [%-.2d Days %-.2d Hours %-.2d Minutes %-.2d Seconds]
        Machine IdleTime [%-.2d Days %-.2d Hours %-.2d Minutes %-.2d Seconds]
        Encrypt Magic Number For This Remote Shell Session [0x%02x]
        00<0G0\0
        252I2
        3%343=3B3L3Z3
        5&5:5
        6%6.636=6K6y6
        7#7-7D7O7Y7
        8#8*858?8L8R8W8l8v8
        8-9^9
        9*:J:a:i:s:
        ```

    - UTF-16 Strings
        ```
        ewmsgapi.dll
        FriendlyName
        Grabber
        Capture Filter
        VS_VERSION_INFO
        StringFileInfo
        080404b0
        CompanyName
        Microsoft Corporation
        FileDescription
        File Encryption Utility
        FileVersion
        5.1.2201.1329
        InternalName
        X-doorc
        LegalCopyright
        (C) Microsoft Corporation. All rights reserved.
        OriginalFilename
        ProductName
        Microsoft(R) Windows(R) Operating System
        ProductVersion
        5.1.2201.1329
        VarFileInfo
        Translation
        ```

    - Stack Strings
        ```
        fA03
        vidcMPG4
        vidcMPG4
        vidcMPG4
        vidcDIVX
        ```

Questions
1. What is the address of `DllMain`?
    - `1000D02E`

2. Use the Imports window to browse to `gethostbyname`. Where is the import located?
    - `100163CC`

3. How many functions call `gethostbyname`?
    - 5 direct cross-references
    ![gethostbyname](./gethostbyname.png)

4. Focusing on the call to `gethostbyname` located at `0x10001757`, can you figure out which DNS request will be made?
    - pics.praticalmalwareanalysis.com

5. How many local variables has IDA Pro recognized for the subroutine at `0x10001656`?
    - 12

6. How many parameters has IDA Pro recognized for the subroutine at `0x10001656`?
    - None

7. Use the Strings window to locate the string `\cmd.exe /c` in the disassembly. Where is it located?
    - `0x10095B34`
    
8. What is happening in the area of code that references `\cmd.exe /c`?

9. In the same area, at `0x100101C8`, it looks like `dword_1008E5C4` is a global variable that helps decide which path to take. How does the malware set `dword_1008E5C4`? (Hint: Use `dword_1008E5C4â€™s` cross-references.)

10. A few hundred lines into the subroutine at `0x1000FF58`, a series of comparisons use memcmp to compare strings. What happens if the string comparison to robotwork is successful (when memcmp returns 0)?

11. What does the export `PSLIST` do?

12. Use the graph mode to graph the cross-references from `sub_10004E79`. Which API functions could be called by entering this function? Based on the API functions alone, what could you rename this function?

13. How many Windows API functions does `DllMain` call directly? How many at a depth of 2?

14. At `0x10001358`, there is a call to `Sleep` (an API function that takes one parameter containing the number of milliseconds to sleep). Looking backward through the code, how long will the program sleep if this code executes?

15. At `0x10001701` is a call to socket. What are the three parameters?

16. Using the MSDN page for socket and the named symbolic constants functionality in IDA Pro, can you make the parameters more meaningful? What are the parameters after you apply changes?

17. Search for usage of the in instruction (opcode `0xED`). This instruction is used with a magic string `VMXh` to perform VMware detection. Is that in use in this malware? Using the cross-references to the function that executes the in instruction, is there further evidence of VMware detection?

18. Jump your cursor to `0x1001D988`. What do you find?

19. If you have the IDA Python plug-in installed (included with the commercial version of IDA Pro), run Lab05-01.py, an IDA Pro Python script provided with the malware for this book. (Make sure the cursor is at `0x1001D988`.) What happens after you run the script?

20. With the cursor in the same location, how do you turn this data into a single ASCII string?

21. Open the script with a text editor. How does it work?