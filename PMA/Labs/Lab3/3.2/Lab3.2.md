Analyze the malware found in the file `Lab03-02.dll` using basic dynamic analysis tools.

### Static Analysis

- Imports
    - File
        - GetCurrentDirectoryA, GetModuleFileNameA 

    - Process 
        - CreateProcessA

    - Service
        - OpenServiceA, DeleteService, OpenSCManagerA,  RegisterServiceCtrlHandlerA, CreateServiceA, CloseServiceHandle, SetServiceStatus

    - Registry
        - RegOpenKeyExA, RegCloseKey, RegCreateKeyA, RegSetValueExA

    - Network (`WS2_32.dll` functions are imported by ordinal)
        - InternetCloseHandle, InternetOpenA, InternetConnectA, HttpOpenRequestA, HttpSendRequestA, HttpQueryInfoA, InternetReadFile
        - inet_addr, WSASocketA, closesocket, connect, ioctlsocket, send, select, recv, shutdown, WSAStartup, gethostvalue, htons

    - Miscellaneous
        - OutputDebugStringA
        - WaitForSingleObject
        - GetSystemTime
        - Sleep

- Exports
    - `Install`
    - `ServiceMain`
    - `UninstallService`
    - `installA`
    - `uninstallA`

- Miscellaneous
    - No indications of packing, `Microsoft Visual C++ 6.0 DLL` compiled DLL
    - No embedded resources (no `.rsrc` section present)
        - No resources extracted using Resource Hacker

- Embedded Strings
    - Base64 encoded strings
        - `Y29ubmVjdA==` : `connect`
        - `dW5zdXBwb3J0` :  `unsupport`
        - `c2xlZXA=` : `sleep`
        - `Y21k`: `cmd`
        - `cXVpdA==`: `quit`
    - Strings of interest
        ```
        Y29ubmVjdA==
        practicalmalwareanalysis.com
        serve.html
        dW5zdXBwb3J0
        c2xlZXA=
        Y21k
        cXVpdA==
        Windows XP 6.11
        CreateProcessA
        kernel32.dll
        .exe
        HTTP/1.1
        %s %s
        1234567890123456
        quit
        exit
        getfile
        cmd.exe /c 
        ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/
        --!>
        <!--
        .PAX
        .PAD
        DependOnService
        RpcSs
        ServiceDll
        GetModuleFileName() get dll path
        Parameters
        Type
        Start
        ObjectName
        LocalSystem
        ErrorControl
        DisplayName
        Description
        Depends INA+, Collects and stores network configuration and location information, and notifies applications when this information changes.
        ImagePath
        %SystemRoot%\System32\svchost.exe -k 
        SYSTEM\CurrentControlSet\Services\
        CreateService(%s) error %d
        Intranet Network Awareness (INA+)
        %SystemRoot%\System32\svchost.exe -k netsvcs
        OpenSCManager()
        You specify service name not in Svchost//netsvcs, must be one of following:
        RegQueryValueEx(Svchost\netsvcs)
        netsvcs
        RegOpenKeyEx(%s) KEY_QUERY_VALUE success.
        RegOpenKeyEx(%s) KEY_QUERY_VALUE error .
        SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost
        IPRIP
        uninstall success
        OpenService(%s) error 2
        OpenService(%s) error 1
        uninstall is starting
        .?AVtype_info@@
        080@0^0m0r0
        ```

- CAPA Report
    ```
    ┍━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
    │ md5                    │ 84882c9d43e23d63b82004fae74ebb61                                                                                                               │
    │ sha1                   │ c6fb3b50d946bec6f391aefa4e54478cf8607211                                                                                                       │
    │ sha256                 │ 5eced7367ed63354b4ed5c556e2363514293f614c2c2eb187273381b2ef5f0f9                                                                               │
    │ analysis               │ static                                                                                                                                         │
    │ os                     │ windows                                                                                                                                        │
    │ format                 │ pe                                                                                                                                             │
    │ arch                   │ i386                                                                                                                                           │
    │ path                   │ C:/Users/bong/Desktop/Practicals/PracticalMalwareAnalysis-Labs-master/Practical Malware Analysis Labs/BinaryCollection/Chapter_3L/Lab03-02.dll │
    ┕━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙

    ┍━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
    │ ATT&CK Tactic          │ ATT&CK Technique                                                                   │
    ┝━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
    │ DEFENSE EVASION        │ Obfuscated Files or Information T1027                                              │
    ├────────────────────────┼────────────────────────────────────────────────────────────────────────────────────┤
    │ DISCOVERY              │ File and Directory Discovery T1083                                                 │
    │                        │ Query Registry T1012                                                               │
    │                        │ System Information Discovery T1082                                                 │
    │                        │ System Network Configuration Discovery T1016                                       │
    ├────────────────────────┼────────────────────────────────────────────────────────────────────────────────────┤
    │ EXECUTION              │ Command and Scripting Interpreter::Windows Command Shell T1059.003                 │
    │                        │ Shared Modules T1129                                                               │
    │                        │ System Services::Service Execution T1569.002                                       │
    ├────────────────────────┼────────────────────────────────────────────────────────────────────────────────────┤
    │ PERSISTENCE            │ Create or Modify System Process::Windows Service T1543.003                         │
    ┕━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙

    ┍━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
    │ MAEC Category               │ MAEC Value                                                                    │
    ┝━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
    │ malware-category            │ downloader                                                                    │
    ┕━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙

    ┍━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
    │ MBC Objective               │ MBC Behavior                                                                  │
    ┝━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
    │ ANTI-BEHAVIORAL ANALYSIS    │ Conditional Execution::Runs as Service [B0025.007]                            │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ COMMAND AND CONTROL         │ C2 Communication::Receive Data [B0030.002]                                    │
    │                             │ C2 Communication::Send Data [B0030.001]                                       │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ COMMUNICATION               │ HTTP Communication::Connect to Server [C0002.009]                             │
    │                             │ HTTP Communication::Create Request [C0002.012]                                │
    │                             │ HTTP Communication::Get Response [C0002.017]                                  │
    │                             │ HTTP Communication::Read Header [C0002.014]                                   │
    │                             │ HTTP Communication::Send Request [C0002.003]                                  │
    │                             │ Interprocess Communication::Create Pipe [C0003.001]                           │
    │                             │ Socket Communication::Get Socket Status [C0001.012]                           │
    │                             │ Socket Communication::Initialize Winsock Library [C0001.009]                  │
    │                             │ Socket Communication::Receive Data [C0001.006]                                │
    │                             │ Socket Communication::Send Data [C0001.007]                                   │
    │                             │ Socket Communication::Set Socket Config [C0001.001]                           │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ CRYPTOGRAPHY                │ Encrypt Data::RC4 [C0027.009]                                                 │
    │                             │ Encryption Key::RC4 KSA [C0028.002]                                           │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ DATA                        │ Check String [C0019]                                                          │
    │                             │ Encode Data::Base64 [C0026.001]                                               │
    │                             │ Encode Data::XOR [C0026.002]                                                  │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ DEFENSE EVASION             │ Obfuscated Files or Information::Encoding-Standard Algorithm [E1027.m02]      │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ DISCOVERY                   │ File and Directory Discovery [E1083]                                          │
    │                             │ System Information Discovery [E1082]                                          │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ FILE SYSTEM                 │ Read File [C0051]                                                             │
    │                             │ Writes File [C0052]                                                           │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ OPERATING SYSTEM            │ Registry::Query Registry Value [C0036.006]                                    │
    │                             │ Registry::Set Registry Key [C0036.001]                                        │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ PROCESS                     │ Create Process [C0017]                                                        │
    │                             │ Create Thread [C0038]                                                         │
    │                             │ Terminate Thread [C0039]                                                      │
    ┕━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙

    ┍━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
    │ Capability                                               │ Namespace                                            │
    ┝━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
    │ read and send data from client to server                 │ communication/c2/file-transfer                       │
    │ receive and write data from server to client (2 matches) │ communication/c2/file-transfer                       │
    │ execute shell command and capture output                 │ communication/c2/shell                               │
    │ check HTTP status code                                   │ communication/http/client                            │
    │ get socket status (2 matches)                            │ communication/socket                                 │
    │ initialize Winsock library (2 matches)                   │ communication/socket                                 │
    │ set socket configuration                                 │ communication/socket                                 │
    │ encode data using Base64                                 │ data-manipulation/encoding/base64                    │
    │ reference Base64 string                                  │ data-manipulation/encoding/base64                    │
    │ encode data using XOR (6 matches)                        │ data-manipulation/encoding/xor                       │
    │ encrypt data using RC4 KSA                               │ data-manipulation/encryption/rc4                     │
    │ get common file path (3 matches)                         │ host-interaction/file-system                         │
    │ read file on Windows                                     │ host-interaction/file-system/read                    │
    │ write file on Windows (2 matches)                        │ host-interaction/file-system/write                   │
    │ print debug messages (2 matches)                         │ host-interaction/log/debug/write-event               │
    │ get hostname                                             │ host-interaction/os/hostname                         │
    │ create process on Windows                                │ host-interaction/process/create                      │
    │ query or enumerate registry value                        │ host-interaction/registry                            │
    │ run as service                                           │ host-interaction/service                             │
    │ create service                                           │ host-interaction/service/create                      │
    │ delete service                                           │ host-interaction/service/delete                      │
    │ create thread                                            │ host-interaction/thread/create                       │
    │ terminate thread                                         │ host-interaction/thread/terminate                    │
    │ link function at runtime on Windows                      │ linking/runtime-linking                              │
    │ persist via Windows service (2 matches)                  │ persistence/service                                  │
    ┕━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙
    ```

### Reverse Engineering
- DLL entrypoint at `1000314D` (`Dllmain`)
    - Attached to current calling process (`fdwReason` = `DLL_PROCESS_ATTACH`)
    - Calls `GetModuleFileNameA` to update `dword_1000FDA4`

- `installA` (`10004B0B`)
    - Calls `Install`

- `Install` (`10004706`)
    > Registry modification and service creation for malware persistence
    - Opens the subkey at `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost`
        - If subkey is not successfully opened, call `OuputDebugStringA` to log error
            ```
            RegOpenKeyEx(%s) KEY_QUERY_VALUE error .
            ```
        - Otherwise, jump to `loc_10004782` and log successful access by calling `OutputDebugStringA`
            ```
            RegOpenKeyEx(%s) KEY_QUERY_VALUE success.
            ```
    - At `loc_10004782`, query `netsvcs` value at `KEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost`, and proceeds to close the key and set the last error to the value returned by `RegQueryValueExA`
        - If there was any error, throw exception by calling `_CxxThrowException`
            ```
            RegQueryValueEx(Svchost\netsvcs)
            ```
    - Check each value returned from the value query against `IPRIP` to see if it is already added.
        - If the value is not present, log error by calling `OutputDebugStringA`
            ```
            You specify service name not in Svchost//netsvcs, must be one of following:
            ```
        - If the data buffer read from the previous call to `RegQueryValueExA` is empty, throw an exception by calling `_CxxThrowException`
    - Next open the service control manager by calling `OpenSCManager ` with requested access of `SC_MANAGER_ALL_ACCESS`
        - If any error was encountered throw an exception by calling `_CxxThrowException`
            ```
            OpenSCManager()
            ```
    - Next, create a service by calling `CreateServiceA` with the following parameters:
        - Service Name: `IPRIP`
        - Display Name: `Intranet Network Awareness (INA+)`
        - Desired Access: `SERVICE_ALL_ACCESS`
        - Service Type: `SERVICE_WIN32_SHARE_PROCESS`
        - Start Type: `SERVICE_AUTO_START`
        - Error Control: `SERVICE_ERROR_NORMAL`
        - Binary Path: `%SystemRoot%\System32\svchost.exe -k netsvcs`
    - If the service creation failed, log the error by calling `OutputDebugStringA` and throw an exception by calling `CxxThrowException`
        ```
        CreateService(%s) error %d
        ```
    - Next, create a registry key at `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\IPRIP`
    - Next, set the values for the newly created key:      
        - ImagePath: `%SystemRoot%\System32\svchost.exe -k netsvcs`
        - Description: `Depends INA+, Collects and stores network configuration and location information, and notifies applications when this information changes.`
        - DisplayName: `Intranet Network Awareness (INA+)`
        - ErrorControl: `1`
        - ObjectName: `LocalSystem`
        - Start: `1`
        - Type: `1`
    - Next create a new key `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\IPRIP\Parameters`
    - Get the DLL's path by calling `GetModuleFileName`
        - If this fails, throw an exception by calling `CxxThrowException`
            ```
            GetModuleFileName() get dll path
            ```
    - Set the values for the newly created `Parameters` key:
        - ServiceDll: DLL file path returned by `GetModuleFileName`
        - DependsOnService: `RpcSs`


- `ServiceMain`
    > Connection to C2 server, receive and parse commands, and execute instructions
    - Register a service control handler, with the service name passed to the function (`RegisterServiceCtrlHandlerA(Destination, HandlerProc)`)
    - Calls the following functions:
        - `sub_10004C38` (`initialiseServiceStatus`) (twice with different parameters) to initialise `SERVICE_STATUS` information and start the service.
            - `sub_10004C38(2u, 0, 1u)`
                - CurrentState = `SERVICE_START_PENDING`
                - ServiceType = `SERVICE_WIN32_SHARE_PROCESS`
                - Win32ExitCode = `NO_ERROR`
                - CheckPoint = `1`
                - ControlsAccepted = `7`
                - WaitHint = `3000` (estimated time in ms for a pending start)
            - `sub_10004C38(4u, 0, 0)`
                - CurrentState = `SERVICE_RUNNING`
                - ServiceType = `SERVICE_WIN32_SHARE_PROCESS`
                - Win32ExitCode = `NO_ERROR`
                - CheckPoint = `0`
                - ControlsAccepted = `7`
                - WaitHint = `3000` (estimated time in ms for a pending start)
        - `Sleep` for one minute
        - `sub_1000321A` (`initialiseNetwork`) to initialise network connection
            - Calls `WSAStartup` to allocate resources for networking libraries
            - Calls `gethostname` to get hostname of infected machine
            - Calls `WSACleanup` to clean up allocated resources
            - Returns the following to the caller: `szAgent` = hostname + ` Windows XP 6.11`
        - `sub_10003286` (`dormantPayload`) to execute payload
            - Calls `sub_1000454E` (`connectC2`) to make a connection to the malware's C2 server
                - Open an internet connection using the previous `szAgent` set, by calling `InternetOpenA`
                - Connects to the C2 server by calling `InternetConnectA`:
                    - Server Name: `practicalmalwareanalysis.com`
                    - Server Port: `80` (`INTERNET_DEFAULT_HTTP_PORT`)
                    - Username: `szPassword` memory location
                    - Password: `szPassword` memory location
                    - ServiceType: `INTERNET_SERVICE_HTTP`
                    - Flags: `INTERNET_FLAG_RAW_DATA`
                - Create a HTTP request by calling `HttpOpenRequestA` with the following:
                    - lpszVerb: `GET`
                    - lpszObjectName: `serve.html`
                    - lpszVersion: `HTTP/1.1`
                    - lpszReferrer: 0
                    - lplpszAcceptTypes: `*/*`
                    - dwFlags: `INTERNET_FLAG_DONT_CACHE`
                - Send the HTTP request by calling `HTTPSendRequestA`
                    - If the request failed, get the last error by calling `GetLastError` before closing the handles to the network connection
                - Call `InternetReadFile` to read a file from the HTTP request and returns the parsed response (`byte_1000BFF0`, `C2httpResponse`) back to the caller
                - Calls `sub_10004654` (`processC2Response`) to process the response received from the C2 server
                    - Check for HTML comments' starting and ending tag (`<!--` and `-->`)
                    - Decode encoded payload within HTML comments one byte at a time, by calling `sub_10004123` (`decodeResponse`) to get a single character
                - According to the value of the key, create a thread to execute its payload and sleep for certain periods of time, depending on the system time.
                    - Created thread executes payload at `10003797` (`StartAddress` / `threadPayload`)
                        - Parse and ensure length validity of thread name
                        - Initialise `sockaddr` structure:
                            - sa_family = 2
                            - sa_data = inet_addr and parsed address
                        - Calls `WSAStartup` to allocate resources for networking libraries
                        - Calls `WSASocketA` to create a socket
                            - af = `AF_INET`
                            - type = `SOCK_STREAM`
                        - protocol = `IPPROTO_TCP`
                        - Connect to socket by calling `connect` and `ioctlsocket`
                            - cmd: 0x8004667E (2147772030)
                        - Send the string `Y29ubmVjdA==` (base64 encoded `connect`) to connect to the C2 server
                        - Enter a loop that ensures the socket is connected by calling `select`
                        - If no packets are received, sleep for 50ms
                        - If a connection is established and packet is received, check the packet contents
                            - If the data received is equal to `cXVpdA==` (base64 encoded quit), end the thread
                            - If the data received is equal to `Y21k` (base64 encoded cmd) call `sub_10003A13` to execute commands on the infected machine
        - `sub_10003A13` (`processC2Commands`)
            - Get current directory by calling `GetCurrentDirectoryA`, and concatenates it with `>`
            - Enter a while-loop
                - Create a pipe and passes the read write handles to a STARTUPINFO struct
                - Prepare command by concatenating:
                    - `cmd.exe /c` with the previous concatenated string (current directory and `>`) 
                - Encode data by calling `sub_10003ED0`
                - Write to pipe and send command
                - Receive packet from pipe and decode it. After decoding check against certain commands to perform actions accordingly:
                    ![command branching](./c2commands.png)
                    - `getfile`: calls `sub_10004363`
                    - `exit` or `quit` : end thread
                    - `cd`: change the current working directory to the attacker's provided one and goes back to the start of the command loop
                        - Create process to read bytes from socket pipe
                    
- `uninstallA` (`10004C2B`)
    - Calls `UninstallService`
    - Calls `GetModuleFileNameA` to update `dword_1000FDA4`
    
- `UninstallService` (`10004B18`)
    - Deletes `IPRIP` service from the registry

### Dynamic Analysis
 - `Install`
- `ServiceMain`
- `UninstallService`
- `installA`
- `uninstallA`

Questions
1. How can you get this malware to install itself?
    - Call `Install` or `installA` function using `rundll32.exe`
        ```
        rundll32.exe Lab03-02.dll, installA
        ```

2. How would you get this malware to run after installation?
    - Run `%SystemRoot%\System32\svchost.exe -k netsvcs`
    - Run `net start IPRIP`
    
3. How can you find the process under which this malware is running?
    - View the process tree of `svchost`

4. Which filters could you set in order to use procmon to glean information?
    - Filter to `svchost.exe` and its services

5. What are the malware’s host-based indicators?
    - Registry
        - New entry: `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\IPRIP`
        - `PRIP` value in: `KEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost`
    - Service
        - New service `IPRIP`

6. Are there any useful network-based signatures for this malware?
    - Connections to `practicalmalwareanalysis.com`, for `serve.html`
    - User agent: ` Windows XP 6.11`