# Lab 1-1 (Static Analysis)

This lab uses the files `Lab01-01.exe` and `Lab01-01.dll`. Use the tools and techniques
described in the chapter to gain information about the files and
answer the questions below.

## Questions
1. Upload the files to http://www.VirusTotal.com/ and view the reports. Does
either file match any existing antivirus signatures?
    - Hashes
        - `Lab01-01.exe`	
            - MD5: `bb7425b82141a1c0f7d60e5106676bb1`	
            - SHA1: `9dce39ac1bd36d877fdb0025ee88fdaff0627cdb`	
            - CRC32: `ad29aa1b`	
            - SHA256: `58898bd42c5bd3bf9b1389f0eee5b39cd59180e8370eb9ea838a0b327bd6fe47`	
            - SHA512: `c407535ccc2df591361eaa52da541ca101c6f320f5246b4d3f53306dcf51e2e930b88b00d01e00334281041da7e66b7e472dce6d01ccba5822869bc6edac6b08`	
            - SHA384: `710cf77064973bec2afe3f1a3186a8a982639a508e368888b2cdea2483175efb217f72a70cdced48abbd18afb75d2d58`
        - `Lab01-01.dll`	
            - MD5: `290934c61de9176ad682ffdd65f0a669`	
            - SHA1: `a4b35de71ca20fe776dc72d12fb2886736f43c22`	
            - CRC32: `c414045d`	
            - SHA256: `f50e42c8dfaab649bde0398867e930b86c2a599e8db83b8260393082268f2dba`	
            - SHA512: `94afcc005e49ee367d483f92708d15d190af15fc5f74b9c70794bf5e4d5a156abce8e7765c7fe8353397c050e6c3ac1007a9b9171c4734a5049173c853aa5e36`	
            - SHA384: `e069c04f7f8d272f4f8759c7f2d834ddd5bdbba320fdbcc1379eb5adcabf6c5c1a32e6b692944c078fd206c6314e0850`
    - Threat Intelligence
        - VirusTotal
            - `Lab01-01.exe`	
                - Flagged by 57/74 security vendors
            - `Lab01-01.dll`	
                - Flagged by 46/74 security vendors
        - Hybrid-Analysis            
            - `Lab01-01.exe`	
                - Flagged as malicious
            - `Lab01-01.dll`	
                - Flagged as malicious

2. When were these files compiled?
    - Analysing the both files' NT Header (Rich Header), we can derive the compile time from its `Time Date Stamp`
    - `Lab01-01.exe`: Sunday, 19.12.2010 16:16:19 UTC (`4D0E2FD3`)
    - `Lab01-01.dll`: Sunday, 19.12.2010 16:16:38 UTC (`4D0E2FE6`)
    - **Revision**: these files are created within seconds of each other, suggesting that they were created at the same time by the same malware author.

3. Are there any indications that either of these files is packed or obfuscated?
If so, what are these indicators?
    - Compare `Virtual Size` and `Size of Raw Data`, especially for the `.text` section
        - The virtual size and size of raw data for both files appear normal
    - Look for the absence of strings, and functions
        - Strings are present in both files
        - Functions are present in both files
    - Look for weird section names
        - Normal sections found for both files
    
    No indications that these files were packed or obfuscated.

4. Do any imports hint at what this malware does? If so, which imports
are they?
    - `Lab01-01.exe`	
        - `KERNEL32.dll` imports suggest file manipulation, including creating, finding and copying of files.
            - `UnmapViewOfFile` which is used to unmap/release a memory-mapped file from a process' address space suggests the possibilty of potential process injection, code injection, self-modification and obfuscation.
    - `Lab01-01.dll`
        - `KERNEL32.dll` imports suggests process creation, and establishing synchronisation mechanisms using mutexes
        - `WS2_32.dll` imports suggest network communications, with a potential C2 server. It includes functions to accept, bind, connect to and close sockets.
            - File imports these functions by ordinal, instead of by name, making it highly suspicious (obfuscation attempt).
        - **Revision**: Being a `DLL` file, there are no exported functions provided, making this file highly suspicious. This could be indicative that it works in tandem with the main `Lab01-01.exe` executable during its activities. 
    
    Taking the imports of both files into consideration, the malware probably performs some file manipulation, and spawns other processes, whilst establishing some network communications. 

5. Are there any other files or host-based indicators that you could look for on infected systems?
    - `Lab01-01.dll`
       - The string `127.26.152.13` was found, which could be the IP address of the malware's C2 server. Since it is a local internal address, this suggests the malware might be communicating to itself or another process on the infected machine (e.g for inter-process communications or local proxies) to forward their traffic
       - **Revision**: Presence of the following strings, which could be indicative of commands that a malicious actor can run on infected machines:
            ```
            exec
            sleep
            hello
            ```
    - `Lab01-01.exe`
        - **Revision**: Presence of the string `kerne132.dll`, with 1 instead of the letter L, `C:\windows\system32\kerne132.dll`, as well as the string `WARNING_THIS_WILL_DESTROY_YOUR_MACHINE`.

6. What network-based indicators could be used to find this malware on infected machines?
    - The presence of the C2 server's IP address `127.26.152.13`.

7. What would you guess is the purpose of these files?
    - `Lab01-01.dll` forms the backbone of the malware, performing process creation and network communications.
    - `Lab01-01.exe` is used to perform file modifications, and potentially for process injection. 


## Solutions
<ins>Short Answers</ins>
1. These files were written specifically for this book, so as of this writing, you should not find a signature for them on VirusTotal.com. Of course, if these files become part of the antivirus signatures as a result of the publication of this book, the results will be different.

2. Both files were compiled on December 19, 2010, **within 1 minute of each
other**.

3. There are no indications that either file is packed or obfuscated.

4. The interesting imports from `Lab01-01.exe` are `FindFirstFile`, `FindNextFile`, and `CopyFile`. These imports tell us that the program searches the filesystem and copies files. The most interesting imports from `Lab01-01.dll` are `CreateProcess` and `Sleep`. We also see that this file imports functions from WS2_32.dll, which provides network functionality.

5. Examine `C:\Windows\System32\kerne132.dll` for additional malicious activity. Note that the file `kerne132.dll`, with the number 1 instead of the letter l, is meant to look like the system file `kernel32.dll`. This file can be used as a host indicator to search for the malware.

6. The `.dll` file contains a reference to local IP address `127.26.152.13`. This address is an artifact of this program having been created for educational and not malicious purposes. If this was real malware, the IP address should be routable, and it would be a good network-based indicator for use in identifying this malware.

7. The `.dll` file is probably a backdoor. The `.exe` file is used to install or run the DLL.

<ins>Detailed Analysis</ins>
1. To answer the first question, we upload the file to VirusTotal.com, which performs a scan against antivirus signatures.

2. Next, we open the files in PEview. For each file, we navigate to the `IMAGE_NT_HEADERS` > `IMAGE_FILE_HEADER` > `Time Date Stamp` field, which tells us the compile time. Both files were compiled on December 19, 2010, within 1 minute of each other. This confirms our suspicions that these files are part of the same package. In fact, a compile time that close strongly suggests that these files were created at the same time by the same author.
    
    We know that the files are related because of the compile times and where they were found. It’s likely that the `.exe` will use or install the `.dll`, because DLLs cannot run on their own.

3. Then we check to see if either file is packed. Both files have small but reasonable numbers of imports and well-formed sections with appropriate sizes. 

    PEiD labels this as unpacked code compiled with Microsoft Visual C++, which tells us that these files are not packed. The fact that the files have few imports tells us that they are likely small programs. Notice that the <ins>DLL file has no exports, which is abnormal, but not indicative of the file being packed</ins>. (You will learn more about this export section when we return to these files in Lab 7-3.)

    Next, we look at the files’ imports and strings beginning with the `.exe`. All of the imports from `msvcrt.dll` are functions that are included in nearly every executable as part of the wrapper code added by the compiler. 
    
    When we look at the imports from `kernel32.dll`, we see functions for opening and manipulating files, as well as the functions `FindFirstFile` and `FindNextFile`. These functions tell us that the malware searches through the filesystem, and that it can open and modify files. We can’t be sure what the program is searching for, but the .exe string suggests that it is searching for executables on the victim’s system. We also see the strings` C:\Windows\System32\Kernel32.dll` and `C:\windows\system32\kerne132.dll`. **(Notice the change from the letter l to the number 1 in kernel32.dll.)** The file `kerne132.dll` is clearly meant to disguise itself as the Windows `kernel32.dll` file. The file `kerne132.dll` can serve as a host-based indicator to locate infections, and it is one that we should analyze for malicious code. 
    
    Next, we look at the imports and strings for `Lab01-01.dll`, which imports functions from `WS2_32.dll`. Because these functions are imported by ordinal, we don’t know which functions are being imported. We also see two interesting functions imported from `kernel32.dll`: `CreateProcess` and `Sleep`, which are commonly used as backdoors. These functions are particularly interesting to us in combination with the strings `exec` and `sleep`. The `exec` string is probably sent over the network to command the backdoor to run a program with `CreateProcess`. The `sleep` string is probably used to command the backdoor program to sleep. (This malware is complex. We’ll return to it in Lab 7-3, once we have covered the skills to analyze it fully.)

## Reference
- [Sample Solutions](https://github.com/SafeEval/practical-malware-analysis/blob/master/exercises/lab-01-1.md)