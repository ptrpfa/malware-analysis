# Analyze the file Lab01-04.exe

## Questions

1. Upload the Lab01-04.exe file to [VirusTotal](http://www.VirusTotal.com/). Does it match any existing antivirus definitions?

    <ins>`Lab01-04.exe`</ins>
    - First derive the hash of `Lab01-04.exe`:	
        - MD5: `625ac05fd47adc3c63700c3b30de79ab`
        - SHA1: `9369d80106dd245938996e245340a3c6f17587fe`	
        - CRC32: `ad10b9a8`	
        - SHA256: `0fa1498340fca6c562cfa389ad3e93395f44c72fd128d7ba08579a69aaf3b126`	
        - SHA512: `2c1ded32a5978810012e2d6b9dd7ffc70a59decf513b93fe7faf1b1097b4b23c1a30a4c514aa8c383046e2e4194ef7be2ef229dc5353e9e0f4fcd3e1a900b19f`	
        - SHA384: `b518b0e6b2d4d59ac2f61ea33b007ea5a1497974870e154361b45b9ebf01141ce4773f590a69bd81ebed474a4f08d538`
    - VirusTotal
        - The file was flagged by 64/73 security vendors
    - Hybrid-Analysis
        - Flagged as malicious
    
    <ins>Extracted PE32</ins>
    - MD5: `6a95c2f88e0c09a91d69ffb98bc6fce8`
    - SHA1: `efb10a2db52d5379e72b392791b456253c5033d4`	
    - CRC32: `28996076`	
    - SHA256: `819b2db1876d85846811799664d512b2f1af13e329f5debe60926c3b03424745`	
    - SHA512: `e09661b58393c0f73edb539208becfb17a67869ae5be6bad325e63a06f8b57fa4511c5684467045a67d999e67ffcbba43b433ee96fa230f6324aa675e222d2d1`	
    - SHA384: `4a466dbc1e8da02d83ebd53c9cace54ff68dc803a76a06b8a1d218448e30fbca892c199fdb836497a9f7cc99b013181f`
    - VirusTotal
        - The file was flagged by 60/73 security vendors
    - Hybrid-Analysis
        - Flagged as malicious
        
2. Are there any indications that this file is packed or obfuscated?  If so, what are these indicators? If the file is packed, unpack it if possible.

    <ins>`Lab01-04.exe`</ins>
    - PE Section Headers
        - No weird section headers found, normal section headers
        - No abnormal mismatch in the virtual and raw data size of sections
        - Signature: `Microsoft Visual C++ 6.0`
    - Embedded Strings
        - No abnormal amount of embedded strings found
        - No potential packers found in embedded strings

    The file does not seem to be packed or obfuscated.
    
    <ins>Extracted PE32</ins>
    - PE Section Headers
        - No weird section headers found, normal section headers
        - No abnormal mismatch in the virtual and raw data size of sections
        - Signature: `Microsoft Visual C++ 6.0`
    - Embedded Strings
        - No abnormal amount of embedded strings found
        - No potential packers found in embedded strings

    The file does not seem to be packed or obfuscated.

3. When was this program compiled?
    - `Lab01-04.exe`
        - `Fri Aug 30 22:26:59 2019`
    - Extracted PE32
        - `Sun Feb 27 00:16:59 2011 (UTC)`

    Embedded executable was compiled a long time before the main executable. 
    
    **Revision**: the difference in compilation dates between both executables could be indicative that the compile time has been faked.

4. Do any imports hint at this program’s functionality?  If so, which imports are they and what do they tell you?
    
    <ins>`Lab01-04.exe`</ins>
    - Process Manipulation
        - Utilises functions like `WinExec`, `GetCurrentProcess`, `OpenProcess`, `WinExec`
    - Resource Manipulation (embedded resource)
        - Utilises functions like `FindResourceA`, `SizeOfResource`
    - File Manipulation
        - Utilises functions like `MoveFileA`, `WriteFile`, `CreateFileA`, `MoveFileA`, `LoadResource`
    - Thread Manipulation
        - Utilises functions like `CreateRemoteThread`, `CloseHandle`
    - Privilege Escalation
        - Utilises functions like `OpenProcessToken`, `LookupPrivilegeValueA`, and `AdjustTokenPrivileges`
    - Termination
        - Utilises `exit` function from the `MSVCRT.dll`

    <ins>Embedded PE32</ins>
    - Process Manipulation
        - Utilises functions like `WinExec`
        - Presence of potential processes that are modified:
            ```
                \system32\wupdmgrd.exe
                \winup.exe
            ```
    - Download of Payload
        - Utilises functions like `URLDownloadToFileA`
        - Presence of incriminating embedded strings:
            ```
            http://www.practicalmalwareanalysis.com/updater.exe
            ```

5. What host- or network-based indicators could be used to identify this malware on infected machines?
    - Embedded executable within the main `Lab01-04.exe` executable, found at ofset `0x4010`.
    - Embedded strings:
        ```
        http://www.practicalmalwareanalysis.com/updater.exe
        \system32\wupdmgr.exe
        winlogon.exe
        <not real>
        SeDebugPrivilege
        \winup.exe
        ```
6. This file has one resource in the resource section. Use Resource Hacker to examine that resource, and then use it to extract the resource. What can you learn from the resource?
    - 32-bit PE32 executable embedded at offset `0x4010`.

## Solutions
<ins>Short Answers</ins>
1. As of this writing, 16 of 43 antivirus engines identify this as malicious code that downloads and/or drops additional malware onto a system.

2. There are no indications that the file is packed or obfuscated.

3. According to the file header, this program was compiled in August 2019. Clearly, the compile time is faked, and we can’t determine when the file
was compiled.

4. The imports from `advapi32.dll` indicate that the program is doing something with permissions. The imports from `WinExec` and `WriteFile`, along with the results from VirusTotal.com, tell us that the program writes a file to disk and then executes it. There are also imports for reading information from the resource section of the file.

5. The string `\system32\wupdmgr.exe` indicates that this program could create or modify a file at that location. The string `www.malwareanalysisbook.com/updater.exe` probably indicates where additional malware is stored, ready for download.

6. The resource section contains another PE executable. Use Resource
Hacker to save the resource as binary data, and then analyze the binary file as you would analyze any executable. The executable in the resource section is a downloader program that downloads additional malware.

<ins>Detailed Analysis</ins>
- For the `Lab01-04.exe` file, the results from VirusTotal.com suggest a program related to a downloader. `PEview` gives no indication that the file is packed or obfuscated.

- The imports from `advapi32.dll` tell us that program does something
with permissions, and we can assume that it tries to access protected files using special permissions. The imports from `kernel32.dll` tell us that the program loads data from the resource section (`LoadResource`, `FindResource`, and `SizeOfResource`), writes a file to disk (`CreateFile` and `WriteFile`), and executes a file on the disk (`WinExec`). We can also guess that the program writes files to the system directory because of the calls to `GetWindowsDirectory`.
- Examining the strings, we see `www.malwareanalysisbok.com/updater.exe`, which is probably the location that holds the malicious code for download. We also see the string `\system32\wupdmgr.exe`, which, in combination with the call to `GetWindowsDirectory`, suggests that a file in `C:\Windows\System32\wupdmgr.exe` is created or edited by this malware.

- We now know with some confidence that this malicious file downloads
new malware. We know where it downloads the malware from, and we can guess where it stores the downloaded malware. The only thing that’s odd is that the program doesn’t appear to access any network functions. The most interesting part of this malware is the resource section. When we open this malware in Resource Hacker, we see one resource. 
- Resource Hacker identifies the type of the resource as binary, meaning arbitrary binary data, and when we look at the data, most of it is meaningless. But notice the string `!This program cannot be run in DOS mode`. This string is the error message included in the DOS header at the beginning of all PE files. We can therefore conclude that this resource is an additional executable file stored in the resource section of `Lab01-04.exe`. This is a fairly common technique used in malware.
- To continue analyzing this file with Resource Hacker, we click Action > Save resource as binary file. After saving the resource, we open the file in `PEview` to analyze the file embedded within it. Looking at the imports, we see that the embedded file is the one that accesses the network functions. It calls `URLDownloadToFile`, a function commonly used by malicious downloaders. It also calls `WinExec`, which probably executes the downloaded file.

## References
- [Sample Solutions](https://github.com/SafeEval/practical-malware-analysis/blob/master/exercises/lab-01-4.md)