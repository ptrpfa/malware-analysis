# Lab 13-3
Analyze the malware found in the file Lab13-03.exe.

## Static Analysis
- Imports
    - Process
        - VirtualAlloc, GetCurrentProcess, TerminateProcess, CreateThread
    
    - File
        - WriteFile

    - Network
        - WSAStartup, WSASocketA, gethostbyvalue, connect, htons 

    - Miscellaneous
        - GetEnvironmentStrings

- Encoding
    - Malware exhibited signes of encoding, particularly using Rijndael (AES) cipher, and a custom base64 encoding character set
    - Rijndael (AES) cipher
        - PEID
            ![PEID](peid.png)
            ```
            RIJNDAEL [S] [char] :: 0000C908 :: 0040C908
                Referenced at 00401E95
                Referenced at 00401EB0
                Referenced at 00401ECB
                Referenced at 00401EE9
                Referenced at 00402002
                Referenced at 0040201B
                Referenced at 00402039
                Referenced at 00402057
                Referenced at 004025F1
                Referenced at 00402610
                Referenced at 00402631
                Referenced at 0040264F
                Referenced at 00402674
                Referenced at 00402695
                Referenced at 004026B5
                Referenced at 004026D3
                Referenced at 004026F7
                Referenced at 00402718
                Referenced at 00402739
                Referenced at 00402756
                Referenced at 0040277B
                Referenced at 0040279B
                Referenced at 004027BC
                Referenced at 004027DA
                Referenced at 0040308F
                Referenced at 004030CC
                Referenced at 00403109
                Referenced at 00403143
            RIJNDAEL [S-inv] [char] :: 0000CA08 :: 0040CA08
                Referenced at 00402BAC
                Referenced at 00402BCB
                Referenced at 00402BEC
                Referenced at 00402C0A
                Referenced at 00402C2F
                Referenced at 00402C50
                Referenced at 00402C70
                Referenced at 00402C8E
                Referenced at 00402CB2
                Referenced at 00402CD3
                Referenced at 00402CF4
                Referenced at 00402D11
                Referenced at 00402D36
                Referenced at 00402D56
                Referenced at 00402D77
                Referenced at 00402D95
                Referenced at 00403456
                Referenced at 00403493
                Referenced at 004034D0
                Referenced at 0040350A
            ```
        - FindCrypt3
            ![FindCrypt3](findcrypt.png)
            ```
            [FindCrypt3] - 0x40C908: found const array Rijndael_sbox (used in Rijndael), size = 256, elsize = 1
            [FindCrypt3] - 0x40CA08: found const array Rijndael_inv_sbox (used in Rijndael), size = 256, elsize = 1
            [FindCrypt3] - 0x40CB08: found const array Rijndael_Te0 (used in Rijndael), size = 256, elsize = 4
            [FindCrypt3] - 0x40CF08: found const array Rijndael_Te1 (used in Rijndael), size = 256, elsize = 4
            [FindCrypt3] - 0x40D308: found const array Rijndael_Te2 (used in Rijndael), size = 256, elsize = 4
            [FindCrypt3] - 0x40D708: found const array Rijndael_Te3 (used in Rijndael), size = 256, elsize = 4
            [FindCrypt3] - 0x40DB08: found const array Rijndael_Td0 (used in Rijndael), size = 256, elsize = 4
            [FindCrypt3] - 0x40DF08: found const array Rijndael_Td1 (used in Rijndael), size = 256, elsize = 4
            [FindCrypt3] - 0x40E308: found const array Rijndael_Td2 (used in Rijndael), size = 256, elsize = 4
            [FindCrypt3] - 0x40E708: found const array Rijndael_Td3 (used in Rijndael), size = 256, elsize = 4
            [FindCrypt3] - 0x40EB08: found const array AES_Rijndael_Tks0 (used in AES/Rijndael), size = 256, elsize = 4
            [FindCrypt3] - 0x40EF08: found const array AES_Rijndael_Tks1 (used in AES/Rijndael), size = 256, elsize = 4
            [FindCrypt3] - 0x40F308: found const array AES_Rijndael_Tks2 (used in AES/Rijndael), size = 256, elsize = 4
            [FindCrypt3] - 0x40F708: found const array AES_Rijndael_Tks3 (used in AES/Rijndael), size = 256, elsize = 4
            [FindCrypt3] - 0x40FB08: found const array Rijndael_rcon (used in Rijndael), size = 30, elsize = 1
            [FindCrypt3] - 0x412B40: found const array __XcptActTab (used in VC CRT/UCRT Library), size = 30, elsize = 4
            [FindCrypt3] - 0x412C80: found const array __rgctypeflag (used in VC CRT/UCRT Library), size = 8, elsize = 1
            [FindCrypt3] - 0x412C88: found const array __rgcode_page_info (used in VC CRT/UCRT Library), size = 240, elsize = 1
            [FindCrypt3] - Found 18 known constant arrays in total.
            WindowStateChange Output window
            ```
        - Occurrences of `xor` instruction
            ![xor](xor.png)
    - Custom Base64
        - Embedded Strings
            ```
            CDEFGHIJKLMNOPQRSTUVWXYZABcdefghijklmnopqrstuvwxyzab0123456789+/
            ```
    - Potential strings of interest
        ```
        ERROR: API    = %s.
        error code = %d.
        message    = %s.
        cmd.exe
        ijklmnopqrstuvwx
        www.practicalmalwareanalysis.com
        lkjiponmtsrqxwvu
        11nV_#<)
        ```

- Miscellaneous
    - No signs of packing, `Microsoft Visual C++ 6.0` compiled binary
    - No embedded resources

- Embedded Strings
    - Strings of Interest
        - Custom Base64 character set
            ```
            CDEFGHIJKLMNOPQRSTUVWXYZABcdefghijklmnopqrstuvwxyzab0123456789+/
            ```
        - Some form of key/block encoding mechanism
            ```
            Data not multiple of Block Size
            Empty key
            Incorrect key length
            Incorrect block length
            ```
        - Domain: `www.practicalmalwareanalysis.com`
        - Executable: `cmd.exe`
    ```
    ios::eofbit set
    ios::failbit set
    ios::badbit set
    string too long
    invalid string position
    Unknown exception
    CDEFGHIJKLMNOPQRSTUVWXYZABcdefghijklmnopqrstuvwxyzab0123456789+/
    ERROR: API    = %s.
    error code = %d.
    message    = %s.
    cmd.exe
    ijklmnopqrstuvwx
    www.practicalmalwareanalysis.com
    Object not Initialized
    Data not multiple of Block Size
    Empty key
    Incorrect key length
    Incorrect block length
    lkjiponmtsrqxwvu
    11nV_#<)
    Object not Initializ
    lkjiponmtsrqxwvu
    11nV_#<)
    .?AVexception@@
    .?AVios_base@std@@
    .?AV?$basic_ios@DU?$char_traits@D@std@@@std@@
    .?AV?$basic_istream@DU?$char_traits@D@std@@@std@@
    .?AV?$basic_ostream@DU?$char_traits@D@std@@@std@@
    .?AV?$basic_streambuf@DU?$char_traits@D@std@@@std@@
    .?AV?$basic_filebuf@DU?$char_traits@D@std@@@std@@
    .?AV?$basic_ios@GU?$char_traits@G@std@@@std@@
    .?AV?$basic_istream@GU?$char_traits@G@std@@@std@@
    .?AV?$basic_ostream@GU?$char_traits@G@std@@@std@@
    .?AV?$basic_filebuf@GU?$char_traits@G@std@@@std@@
    .?AV?$basic_streambuf@GU?$char_traits@G@std@@@std@@
    .?AVruntime_error@std@@
    .?AVfailure@ios_base@std@@
    .?AVfacet@locale@std@@
    .?AV_Locimp@locale@std@@
    .?AVlogic_error@std@@
    .?AVlength_error@std@@
    .?AVout_of_range@std@@
    .?AVtype_info@@
    ```

- CAPA Report
    ```
    ┍━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
    │ md5                    │ 98ea0fe0594f0f373d9791886a01db8c                                                                                                                     │
    │ sha1                   │ e98350347b71658ad0e1b4282dc38446462b8166                                                                                                             │
    │ sha256                 │ 86054002565c929215b82615477652d24379b9119bc33ef7f41706ee7e125379                                                                                     │
    │ analysis               │ static                                                                                                                                               │
    │ os                     │ windows                                                                                                                                              │
    │ format                 │ pe                                                                                                                                                   │
    │ arch                   │ i386                                                                                                                                                 │
    │ path                   │ C:/Users/bong/Desktop/Practicals/PracticalMalwareAnalysis-Labs-master/Practical Malware Analysis Labs/BinaryCollection/Chapter_13L/13.3/Lab13-03.exe │
    ┕━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙

    ┍━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
    │ ATT&CK Tactic          │ ATT&CK Technique                                                                   │
    ┝━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
    │ DEFENSE EVASION        │ Obfuscated Files or Information T1027                                              │
    ┕━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙


    ┍━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
    │ MBC Objective               │ MBC Behavior                                                                  │
    ┝━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
    │ COMMUNICATION               │ DNS Communication::Resolve [C0011.001]                                        │
    │                             │ Interprocess Communication::Create Pipe [C0003.001]                           │
    │                             │ Socket Communication::Connect Socket [C0001.004]                              │
    │                             │ Socket Communication::Create TCP Socket [C0001.011]                           │
    │                             │ Socket Communication::Initialize Winsock Library [C0001.009]                  │
    │                             │ Socket Communication::TCP Client [C0001.008]                                  │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ CRYPTOGRAPHY                │ Encrypt Data::AES [C0027.001]                                                 │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ DEFENSE EVASION             │ Obfuscated Files or Information::Encryption-Standard Algorithm [E1027.m05]    │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ FILE SYSTEM                 │ Read File [C0051]                                                             │
    │                             │ Writes File [C0052]                                                           │
    ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
    │ PROCESS                     │ Create Process [C0017]                                                        │
    │                             │ Create Thread [C0038]                                                         │
    │                             │ Terminate Process [C0018]                                                     │
    ┕━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙

    ┍━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
    │ Capability                                           │ Namespace                                            │
    ┝━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
    │ resolve DNS                                          │ communication/dns                                    │
    │ create pipe                                          │ communication/named-pipe/create                      │
    │ create two anonymous pipes                           │ communication/named-pipe/create                      │
    │ initialize Winsock library                           │ communication/socket                                 │
    │ act as TCP client                                    │ communication/tcp/client                             │
    │ encrypt data using AES (5 matches)                   │ data-manipulation/encryption/aes                     │
    │ reference AES constants (5 matches)                  │ data-manipulation/encryption/aes                     │
    │ read file on Windows (2 matches)                     │ host-interaction/file-system/read                    │
    │ write file on Windows (3 matches)                    │ host-interaction/file-system/write                   │
    │ create process on Windows                            │ host-interaction/process/create                      │
    │ terminate process                                    │ host-interaction/process/terminate                   │
    │ create thread (2 matches)                            │ host-interaction/thread/create                       │
    ┕━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙
    ```
## Reverse Engineering
- `main` (`00401879`)
    - Program entrypoint


## Dynamic Analysis
- Process Monitoring

- Registry

- Service

- Network


## Questions
1. Compare the output of strings with the information available via dynamic analysis. Based on this comparison, which elements might be encoded?
    - Potential strings of interest:
        ```
        ERROR: API    = %s.
        error code = %d.
        message    = %s.
        cmd.exe
        ijklmnopqrstuvwx
        www.practicalmalwareanalysis.com
        lkjiponmtsrqxwvu
        11nV_#<)
        ```
    - These strings could be some information about the infected machine, or a command to be sent to the malware's C2 server
    
2. Use static analysis to look for potential encoding by searching for the string `xor`. What type of encoding do you find?
    - It is used extensively in the AES cipher functions
    ![XOR](xor.png)

3. Use static tools like `FindCrypt2`, `KANAL`, and the `IDA Entropy Plugin` to identify any other encoding mechanisms. How do these findings compare with the XOR findings?
    - These tools corroborate the `xor` findings, indicating the use of Rijndael (AES) cipher 

4. Which two encoding techniques are used in this malware?
    - AES and custom base64

5. For each encoding technique, what is the key?
    - Base64
        ```
        CDEFGHIJKLMNOPQRSTUVWXYZABcdefghijklmnopqrstuvwxyzab0123456789+/
        ```

6. For the cryptographic encryption algorithm, is the key sufficient? What else must be known?

7. What does this malware do?

8. Create code to decrypt some of the content produced during dynamic analysis. What is this content?