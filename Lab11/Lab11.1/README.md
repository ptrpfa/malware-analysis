Analyze the malware found in `Lab11-01.exe`.

### Static Analysis
- `Lab11-01.exe`
    - Behaviors of Interest
        - Launcher / Loader: Executable contains embedded DLL file to execute
        - Registry modifications, particularly location where Winlogon loads third-party DLLs
            ```
            HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon
            ```
            - Adds `GinaDll`:`gina.dll` key-value pair

    - Imports
        - Registry
            - RegSetValueExA, RegCreateKeyExA
        - Process
            - VirtualAlloc, GetCurrentProcess, TerminateProcess, 
        - File
            - CreateFileA
        - Miscellaneous
            - GetEnvironmentStrings, FreeEnvironmentStrings, GetEnvironmentVariableA

    - Miscellaneous
        - No indications of packing, compiled using `Microsoft Visual C++ 6.0`
        - Embedded DLL within the `.rsrc` section, detected and extracted using `Resource Hacker`

    - Embedded Strings
        ```
        Runtime Error!
        Program: 
        <program name unknown>
        TGAD
        BINARY
        GinaDLL
        SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon
        msgina32.dll
        \msgina32.dll
        gina.dll
        ```

    - CAPA Report
        ```
        ┍━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
        │ md5                    │ a9c55bb87a7c5c3c923c4fa12940e719                                                                                                                │
        │ sha1                   │ d971656c6c605a6e2130ab83a38420e655428f94                                                                                                        │
        │ sha256                 │ 57d8d248a8741176348b5d12dcf29f34c8f48ede0ca13c30d12e5ba0384056d7                                                                                │
        │ analysis               │ static                                                                                                                                          │
        │ os                     │ windows                                                                                                                                         │
        │ format                 │ pe                                                                                                                                              │
        │ arch                   │ i386                                                                                                                                            │
        │ path                   │ C:/Users/bong/Desktop/Practicals/PracticalMalwareAnalysis-Labs-master/Practical Malware Analysis Labs/BinaryCollection/Chapter_11L/Lab11-01.exe │
        ┕━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙

        ┍━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
        │ ATT&CK Tactic          │ ATT&CK Technique                                                                   │
        ┝━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
        │ PERSISTENCE            │ Event Triggered Execution T1546                                                    │
        ┕━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙


        ┍━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
        │ MBC Objective               │ MBC Behavior                                                                  │
        ┝━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
        │ EXECUTION                   │ Install Additional Program [B0023]                                            │
        ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
        │ OPERATING SYSTEM            │ Registry::Set Registry Key [C0036.001]                                        │
        ┕━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙

        ┍━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
        │ Capability                                           │ Namespace                                            │
        ┝━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
        │ extract resource via kernel32 functions              │ executable/resource                                  │
        │ contain an embedded PE file                          │ executable/subfile/pe                                │
        │ persist via GinaDLL registry key (2 matches)         │ persistence/registry/ginadll                         │
        ┕━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙
        ```

- `msgina32.dll`
    - Behaviors of Interest
        - GINA interception (steal credentials)

    - Imports
        - Registry
            - RegSetValueExA, RegCreateKeyW, RegCloseKey
        - Process
            - ExitProcess
        - File
            - GetSystemDirectoryW, GetModuleFileNameW
    - Exports
        - GINA Interception
            -  WlxActivateUserShell, WlxDisconnectNotify, WlxDisplayLockedNotice, ..
        - Ordinal functions

    - Miscellaneous
        - No indications of packing, compiled using `Microsoft Visual C++ 6.0 DLL`
        - Embedded DLL within the `.rsrc` section (`TGAD`), detected and extracted using `Resource Hacker`

    - Embedded Strings
        ```
        gina.dll
        WlxGetConsoleSwitchCredentials
        \MSGina
        GinaDLL
        Software\Microsoft\Windows NT\CurrentVersion\Winlogon
        MSGina.dll
        UN %s DM %s PW %s OLD %s
        ErrorCode:%d ErrorMessage:%s. 
        %s %s - %s 
        msutil32.sys
        ```

    - CAPA Report
        ```
        ┍━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
        │ md5                    │ 7ce4f799946f0fa44e5b2b5e6a702f27                                                                                                                         │
        │ sha1                   │ 951fb5b80702d02e5c327b56cc709ee3ad5523d2                                                                                                                 │
        │ sha256                 │ f8a4f61bccd5bab1cad0ab9e57f6f3092a8bd4dd0adfcd4853e89ba96afc93f9                                                                                         │
        │ analysis               │ static                                                                                                                                                   │
        │ os                     │ windows                                                                                                                                                  │
        │ format                 │ pe                                                                                                                                                       │
        │ arch                   │ i386                                                                                                                                                     │
        │ path                   │ C:/Users/bong/Desktop/Practicals/PracticalMalwareAnalysis-Labs-master/Practical Malware Analysis Labs/BinaryCollection/Chapter_11L/Lab11-01-embedded.dll │
        ┕━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙

        ┍━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
        │ ATT&CK Tactic          │ ATT&CK Technique                                                                   │
        ┝━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
        │ DISCOVERY              │ File and Directory Discovery T1083                                                 │
        ├────────────────────────┼────────────────────────────────────────────────────────────────────────────────────┤
        │ EXECUTION              │ Shared Modules T1129                                                               │
        ├────────────────────────┼────────────────────────────────────────────────────────────────────────────────────┤
        │ PERSISTENCE            │ Event Triggered Execution T1546                                                    │
        ┕━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙


        ┍━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
        │ MBC Objective               │ MBC Behavior                                                                  │
        ┝━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
        │ DISCOVERY                   │ File and Directory Discovery [E1083]                                          │
        ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
        │ OPERATING SYSTEM            │ Registry::Set Registry Key [C0036.001]                                        │
        ├─────────────────────────────┼───────────────────────────────────────────────────────────────────────────────┤
        │ PROCESS                     │ Terminate Process [C0018]                                                     │
        ┕━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙

        ┍━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┑
        │ Capability                                           │ Namespace                                            │
        ┝━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┥
        │ get common file path                                 │ host-interaction/file-system                         │
        │ terminate process                                    │ host-interaction/process/terminate                   │
        │ link function at runtime on Windows                  │ linking/runtime-linking                              │
        │ persist via GinaDLL registry key (2 matches)         │ persistence/registry/ginadll                         │
        ┕━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┙
        ```

### Dynamic Analysis
- Process (PID: 6912, `Lab11-01.exe`)
    - Creates `C:\Windows\System32\conhost.exe` (PID: 6920)
        ![conhost](conhost.png)
    - Creates new `svchost.exe` process to conceal its execution (same PID of 6912 is used). Queries image file execution options of the executable from the registry.
        ![svchost](svchost.png)

- File
    - Extraction of the embedded DLL into the current directory of the malware (`msgina32.dll`)
        ```
        C:\Users\bong\Desktop\Practicals\PracticalMalwareAnalysis-Labs-master\Practical Malware Analysis Labs\BinaryCollection\Chapter_11L\msgina32.dll
        ```

- Registry
    - Set value of `Winlogon`
        ```
        HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows NT\CurrentVersion\Winlogon\GinaDLL
        ```
    - Regshot
        ```
        ----------------------------------
        Keys added: 12
        ----------------------------------
        HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Component Based Servicing\TiRunning

        ----------------------------------
        Values added: 43
        ----------------------------------
        HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows NT\CurrentVersion\Winlogon\GinaDLL: 43 00 3A 00 5C 00 55 00 73 ...
        ```

### Reverse Engineering
#### `Lab11-01.exe`
- Entrypoint at `main` function (`00401487`)
    - Extracts embedded `msgina32.dll` within the `.rsrc` section by calling `sub_401080`
        ![extract resource](extractresource.png)
    - Get current file path and perform parsing to prepare for the next subroutine call
        ![preparations](preparations.png)
    - Calls `sub_401000` before ending program execution
        - Creates new registry key at `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\GinaDll` and sets its value to `msgina32.dll`
            ![registry](registry.png)
        - Calls subroutine `sub_401299`, passing `RI\n` as its argument
            - Calls subroutine `sub_401679`
            ![sub_401679](sub_401679.png)
                - Switch table to process argument received (`RI\n`), one byte at a time, most likely to write the extracted `msgina32.dll` to a file on the current directory
                ![switch](switch.png)

#### `msgina32.dll`
- Exports legitimate GINA functions:
    - `ShellShutdownDialog`, `WlxActivateUserShell`, `WlxDisconnectNotify`, `WlxDisplayLockedNotice`, `WlxDisplaySASNotice`, `WlxDisplayStatusMessage`, `WlxGetConsoleSwitchCredentials`, `WlxGetStatusMessage`, `WlxInitialize`, `WlxIsLockOk`, `WlxIsLogoffOk`, `WlxLoggedOnSAS`, `WlxLogoff`, `WlxNegotiate`, `WlxNetworkProviderLoad`, `WlxReconnectNotify`, `WlxRemoveStatusMessage`, `WlxScreenSaverNotify`, `WlxShutdown`, `WlxStartApplication`, `WlxWkstaLockedSAS`
    - For each subroutine, the malware calls `getProcessAddr` (`sub_10001000`) to get the original address of the legitimate function. Afterwhich, it executes the normal function.
        ![legitimate](legitimate.png)
    - `getProcessAddr` (`sub_10001000`) dynamically loads a function address from a DLL and returns it to the caller.
        ![load](load.png)

- Apart from these legitimate functions, the malware intercepts the communication between Winlogon and the legtimate `msgina.dll`, specifically for the `WlxLoggedOutSAS` function
    - `WlxLoggedOutSAS` 
        - Calls `getProcessAddr` (`sub_10001000`) to get the original address of the legitimate function, afterwhich it executes it.
        - If a user has logged on successfully, call `stealCredentials` (`sub_10001570`) to get the user's credentials
        ![wlxloggedoutsa](wlxloggedoutsa.png), passing in the username, password, oldpassword, domain and the following string `UN %s DM %s PW %s OLD %s`
    - `stealCredentials` (`sub_10001570`) 
        - Opens the `msutil32.sys` file and writes the captured user credentials to it in the format:
            ```
            Date Time - UN <username> DM <domain> PW <password> OLD <old password>
            ```
            ![steal credentials](stealcredentials.png)

- `DllRegister`
     ![dllregister](dllregister.png)

- `DllUnregister`
    - Calls `sub_100013F0`, passing the argument `MSGina.dll`
     ![dllunregister](dllunregister.png)
    - `sub_100013F0`
        - Creates a new registry key `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlog`
        - Set the value of the newly created key to the argument received, which in this case is `MSGina.dll`
            ![sub_100013F0](sub_100013F0.png)

### Questions
1. What does the malware drop to disk?
    - It extracts an embedded DLL within its `.rsrcs` section (`TGAD`) and drops `msgina32.dll` to its current directory

2. How does the malware achieve persistence?
    - It modifies the `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\GinaDll` registry entry, setting it to the malicious modified `msgina32.dll`, which will be loaded by the Winlogon executable every time during the login process

3. How does the malware steal user credentials?
    - It has a modified `WlxLoggedOutSAS` function within `msgina32.dll` that first executes its legitimate counterpart, afterwhich the user credentials captured are written to the `msutil32.sys` file

4. What does the malware do with stolen credentials?
    - It stores the stolen credentials to the `msutil32.sys` file

5. How can you use this malware to get user credentials from your test
environment?
    - Initiate the login process, and inspect the `msutils.sys` file