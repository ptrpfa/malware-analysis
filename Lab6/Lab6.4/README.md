# Lab 6.4
In this lab, we’ll analyze the malware found in the file `Lab06-04.exe`. 

### Malware Flow
![Main](6.4-main.png)

### Points of Interest
- Embedded Strings
    ```
    Error 1.1: No Internet
    Success: Internet Connection
    Error 2.3: Fail to get command
    Error 2.2: Fail to ReadFile
    Error 2.1: Fail to OpenUrl
    http://www.practicalmalwareanalysis.com/cc.htm
    Internet Explorer 7.50/pma%d
    Error 3.2: Not a valid command provided
    Error 3.1: Could not set Registry value
    Malware
    Software\Microsoft\Windows\CurrentVersion\Run
    C:\Temp\cc.exe
    C:\Temp
    Success: Parsed command is %c
    ```

- Imports
    - Open & setting of registry values
        - `ADVAPI32.dll`: `RegSetValueExA`
        - `ADVAPI32.dll`: `RegOpenKeyExA`
    - Connection to the Internet, downloading & reading a file
        - `WININET.dll`: `InternetOpenUrlA`
        - `WININET.dll`: `InternetCloseHandle`
        - `WININET.dll`: `InternetReadFile`
        - `WININET.dll`: `InternetGetConnectedState`
        - `WININET.dll`: `InternetOpenA`
    - File manipulation
        - `KERNEL32.dll`: `CreateDirectoryA`
        - `KERNEL32.dll`: `WriteFile`
        - `KERNEL32.dll`: `CopyFileA`
        - `KERNEL32.dll`: `DeleteFileA`
    - Process manipulation
        - `KERNEL32.dll`: `GetCurrentProcess`
        - `KERNEL32.dll`: `GetStartupInfo`
        - `KERNEL32.dll`: `ExitProcess`
        - `KERNEL32.dll`: `TerminateProcess`
        - `KERNEL32.dll`: `Sleep`
    - Environment strings manipulation:
        - `KERNEL32.dll`: `GetEnvironmentVariableA`
        - `KERNEL32.dll`: `GetEnvironmentStrings`
        - `KERNEL32.dll`: `GetEnvironmentStrings`

Questions

1. What is the difference between the calls made from the main method in `Labs 6-3` and `6-4`?
    - 6-4 includes a loop construct that loops 1440 times to call `getCommand` which will inadvertedly wait for 1 min at each iteration after executing the command parsed.

2. What new code construct has been added to main?
    - Loop construct

3. What is the difference between this lab’s parse HTML function and those of the previous labs?
    - The user agent used: `Internet Explorer 7.50/pma%d`
    - It also calls the `sprintf` function instead of `printf` for the formatted `%d` argument, where the inputted value is the iteration counter.

4. How long will this program run? (Assume that it is connected to the Internet.)
    - 1440 minutes (24 hours), provided that there are no errors for each iteration of the loop construct

5. Are there any new network-based indicators for this malware?
    - `http://www.practicalmalwareanalysis.com/cc.htm`
    - User agent: `Internet Explorer 7.50/pma%d`

6. What is the purpose of this malware?
    - It repeatedly connects to the C2 server at `http://www.practicalmalwareanalysis.com/cc.htm` for 1440 iterations to fetch the command to execute on the infected machine. Depending on the command, the malware will create the `C:\\Temp` directory and copy the malicious executable specified by the command-line argument when it was run into `C:\\Temp\\cc.exe`. It may also modify the `Software\Microsoft\Windows\CurrentVersion\Run` entry of the registry to add the value `Malware`:`C:\\Temp\\cc.exe` to execute the malicious executable at startup, or delete the `cc.exe` file directly to remove traces of infection.
